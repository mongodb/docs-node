.. _node-whats-new:

==========
What's New
==========

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. facet::
   :name: genre
   :values: reference

.. meta::
   :keywords: version, update, upgrade, backwards compatibility

Learn what's new in:

* :ref:`Version 6.6 <version-6.6>`
* :ref:`Version 6.5 <version-6.5>`
* :ref:`Version 6.4 <version-6.4>`
* :ref:`Version 6.3 <version-6.3>`
* :ref:`Version 6.2 <version-6.2>`
* :ref:`Version 6.1 <version-6.1>`
* :ref:`Version 6.0 <version-6.0>`

.. _version-6.6:

What's New in 6.6
-----------------

The {+driver-short+} v6.6 release includes the following features:

- Upgrades to using BSON 6.7.0. For details about the new BSON features, see the
  release notes for `BSON 6.5.0
  <https://github.com/mongodb/js-bson/releases/tag/v6.5.0>`__,
  `BSON 6.6.0 <https://github.com/mongodb/js-bson/releases/tag/v6.6.0>`__, and
  `BSON 6.7.0 <https://github.com/mongodb/js-bson/releases/tag/v6.7.0>`__.

- Adds the ``addStage()`` method to the fluid aggregation API. You can use this method to
  add aggregation pipeline stages individually, as shown in the following
  example:

  .. code-block:: javascript

     const documents = await users.aggregate().addStage({ $project: { name: true } }).toArray();

- Adds the ``cause`` and ``dependencyName`` fields to the ``MongoMissingDependencyError``
  class. You can use these fields to programmatically determine if a package is missing
  or why a package didn't load.

- Adds the ``minRoundTripTime`` property to the ``ServerDescription`` class. This
  property contains the minimum round-trip time over the last 10 heartbeats.

- Adds the ``toJSON()`` method to the ``TopologyDescription`` class. Although you can use
  this method to stringify ``TopologyDescription`` objects to JSON, we
  recommend using Node's ``util.inspect()`` method instead, because it properly handles
  all types used in JavaScript and the driver.

- Adds cursor options support for the ``Collection.indexExists()``,
  ``Collection.indexes()``, and ``Collection.indexInformation()`` methods in Typescript.

- Removes support for the ``readConcern`` and ``writeConcern`` options from the
  ``Collection.listSearchIndexes()`` method. ``listSearchIndexes()`` is an Atlas-specific method, and Atlas
  search indexes don't support these options.

- Redefines the ``ServerDescription.roundTripTime`` property as a moving average. Previously,
  it was a weighted average of the most recently observed heartbeat duration and the
  previous duration.

- You can specify the type of a search index when creating the index, as shown
  in the following example:

  .. code-block:: js
     :emphasize-lines: 3
    
     const indexName = await collection.createSearchIndex({
         name: 'my-vector-search-index',
         type: 'vectorSearch',
         definition: {
             mappings: { dynamic: false }
         }
     });

- The ``UpdateFilter.$currentDate`` property no longer throws an error when you pass
  it to a compound method, such as ``findOneAndUpdate()``, on a collection with a limited schema.

- The driver throws a ``MongoTransactionError`` only if you provide a
  ``ReadPreferenceMode`` other than ``primary`` and then try to perform a command that
  involves a read operation.

- The data type of the ``TopologyDescription.error`` property is ``MongoError``.

- The ``Collection.indexExists()`` method no longer supports the ``full`` option.

- The ``Collection.indexInformation()``, ``Collection.indexes()``, and
  ``Db.indexInformation()`` methods have a return type of
  ``IndexDescriptionCompact | IndexDescriptionInfo[]`` in TypeScript. 

- When retrieving AWS KMS (Key Management System) credentials, the driver no longer
  throws an error when it receives an access key that includes
  an expiration timestamp.

- The ``ClusterTime`` interface no longer defines the ``signature`` field as required in
  TypeScript.

To learn more about this release, see the
`v6.6.0 Release Highlights
<https://github.com/mongodb/node-mongodb-native/releases/tag/v6.6.0>`__ on
GitHub.

.. _version-6.5:

What's New in 6.5
-----------------

The {+driver-short+} v6.5 release includes the following features:

- Updates bulk write operations to use the ``pkFactory`` class for document
  ID generation.

.. warning::

   If you previously specified an instance of a ``pkFactory`` to handle
   bulk writes, the ``_id`` fields of the documents inserted by using bulk
   writes may be inconsistent with the behavior in this version.

- Fixes the read preference that is sent with read operations to 
  ``primaryPreferred`` when the driver is connected to a secondary node in
  the replica set.

- Fixes a memory leak in promise creation for socket operations.

- Reduces first-time connection latency when connecting to a DNS seedlist by
  querying the ``SRV`` and ``TXT`` records in parallel.

- Adds tracking to container metadata when running a client in Kubernetes
  or a container environment in the ``client.env.container`` field of the
  handshake document.

- Adds the original error document returned by the server to the
  ``errorResponse`` field of the ``MongoServerError`` document.

- Deprecates the ``CloseOptions`` interface which is unused by the driver.

To learn more about this release, see the
`v6.5.0 Release Highlights
<https://github.com/mongodb/node-mongodb-native/releases/tag/v6.5.0>`__ on
GitHub.

.. _version-6.4:

What's New in 6.4
-----------------

The {+driver-short+} v6.4 release includes the following features:

- When multiple ``mongos`` instances are available, different servers are used
  for read and write retry attempts.

- Caches AWS credentials at the client level, rather than for each
  authentication.

- Upgrades to using BSON 6.4.0. For details about the new BSON features, see the
  release notes for `BSON 6.3.0
  <https://github.com/mongodb/js-bson/releases/tag/v6.3.0>`__ and `BSON 6.4.0
  <https://github.com/mongodb/js-bson/releases/tag/v6.4.0>`__.

- Read operations that result in an ``ExceededTimeLimit`` error are retried.

- Fixes a request issue related to :ref:`TLS sockets <node-connect-tls>` and
  :manual:`KMS Providers
  </core/queryable-encryption/fundamentals/kms-providers/>`.

- Fixes the base64 padding on the ``saslContinue`` command to allow for mongosh
  authentication.

- Types ``countDocuments`` using ``Filter<Schema>`` rather than ``Document``,
  which enables autocompletion and helps prevent downstream typing issues.

- Fixes a type error in the ``$addToSet`` option of the ``bulkWrite`` command.
  The driver skips ``$addToSet`` validation you extend your types from
  ``Document`` or ``any``, or use properties of any type.

- Fixes the ``ServerHeartbeatSucceeded`` and ``ServerHeartbeatFailed`` event
  heartbeat duration so that it does not include the time to create the socket.

- Appropriately emits errors from cursor transform streams, rather than
  absorbing them.

- Makes AWS session tokens optional when a username and password are provided,
  and allows AWS SDK to handle the authentication requests.

To learn more about this release, see the
`v6.4.0 Release Highlights
<https://github.com/mongodb/node-mongodb-native/releases/tag/v6.4.0>`__ on
GitHub.

.. _version-6.3:

What's New in 6.3
-----------------

The {+driver-short+} v6.3 release includes the following features:

- Adds the ``serverMonitoringMode`` client option to control the
  behavior of the monitoring connection among the nodes in a topology.
  This option takes a value of ``auto`` (default), ``poll``, or
  ``stream``. To learn more, see the entry for this option in the
  :ref:`node-connection-options` guide.

  You can set the ``serverMonitoringMode`` option in a
  ``MongoClientOptions`` instance or as a connection string option. The
  following example shows how to create a client with the option set to
  ``stream``:

  .. code-block:: js

     new MongoClient('<connection string>', { serverMonitoringMode: 'stream' });

- Fixes a connection leak when the ``serverApi`` client option is set.

- Deprecates the ``contentType`` and ``aliases`` GridFS options. To
  store the content type and aliases of a file, add ``contentType`` and ``aliases``
  fields to the ``metadata`` document.

To learn more about this release, see the
`v6.3.0 Release Highlights
<https://github.com/mongodb/node-mongodb-native/releases/tag/v6.3.0>`__.

.. _version-6.2:

What's New in 6.2
-----------------

The {+driver-short+} v6.2 release includes the following features:

- Updates the ``bson`` package version to 6.2.0 to include
  color visualization of types, as shown in the following image:

  .. figure:: /includes/figures/bson-color.png
     :alt: A screenshot of the terminal that shows printing in color

  To learn more, see the `bson v6.2.0 release notes
  <https://github.com/mongodb/js-bson/releases/tag/v6.2.0>`__.

- Ensures that the ``result.insertedIds`` property of a bulk write error type
  contains the ``_id`` values of successfully inserted documents. In
  previous versions, when a bulk write operation rejected an insert
  operation, the ``result.insertedIds`` property contained the
  ``_id`` values for all attempted inserts.

- Closes the implicit session created when running the ``findOne()``
  method on a time series collection regardless of the outcome of the
  operation.

- Allows the creation of collections that have names that start or end with the
  ``.`` character. This change aligns the driver's database and
  collection name-checking behavior with the server's.

To learn more about this release, see the
`v6.2.0 Release Highlights
<https://github.com/mongodb/node-mongodb-native/releases/tag/v6.2.0>`__.

.. _version-6.1:

What's New in 6.1
-----------------

The {+driver-short+} v6.1 release includes the following features:

- Updates the ``bson`` package version to 6.1.0 to expose the
  ``Decimal128.fromStringWithRounding()`` method. To learn more, see the
  `v6.1.0 bson release notes <https://github.com/mongodb/js-bson/releases/tag/v6.1.0>`__.

- Detects environment variables for region settings when
  authenticating by using the ``MONGODB-AWS`` authentication mechanism.
  To instruct the driver to use your region options, you must set both
  of the following environment variables:

  - ``AWS_STS_REGIONAL_ENDPOINTS``
  - ``AWS_REGION``

- Fixes a memory leak issue caused by recursive calls to the ``next()``
  method of the ``ChangeStream`` type.

To learn more about this release, see the
`v6.1.0 Release Highlights
<https://github.com/mongodb/node-mongodb-native/releases/tag/v6.1.0>`__.

.. _version-6.0:

What's New in 6.0
-----------------

.. warning:: Breaking Changes in v6.0

   This driver version introduces breaking changes. For a list of these changes, see
   the :ref:`Version 6.0 Breaking Changes section <node-breaking-changes-v6.0>` in the
   Upgrade guide.

The {+driver-short+} v6.0 release includes the following features:

.. important:: Deprecation Notice

   All of the ``ssl``-prefixed options in the ``MongoClientOptions``
   type are deprecated. In addition, the ``tlsCertificateFile`` option
   is deprecated.

   Instead, you should store your certificates in a ``SecureContext``
   object or set the ``tls``-prefixed options in your
   ``MongoClientOptions`` instance. To learn more, see :ref:`node-connect-tls`.

- Removal of support for the ``addUser()`` helper command. Use the
  :manual:`createUser </reference/command/createUser>` MongoDB Shell command instead.

- Removal of support for the ``collStats`` operation. Use the
  :manual:`$collStats </reference/operator/aggregation/collStats>` aggregation operator
  instead.

- The ``options`` field of the ``ConnectionPoolCreatedEvent`` type
  contains only the following fields, which are the non-default pool
  options:

  - ``maxConnecting``
  - ``maxPoolSize``
  - ``minPoolSize``
  - ``maxIdleTimeMS``
  - ``waitQueueTimeoutMS``

- The driver asynchronously reads files set in the ``tlsCAFile`` and
  ``tlsCertificateKeyFile`` connection options when you call
  the ``MongoClient.connect()`` method, not when you create a
  ``MongoClient`` instance.

- Removal of the ``keepAlive`` and ``keepAliveInitialDelay`` connection
  options. The value of ``keepAlive`` is permanently set to ``true`` and the
  value of ``keepAliveInitialDelay`` is set to 300000 milliseconds (300
  seconds).

  To learn how to set keepalive settings at a system level,
  see the :manual:`Does TCP keepalive time affect MongoDB Deployments? </faq/diagnostics/#does-tcp-keepalive-time-affect-mongodb-deployments->`
  FAQ entry in the Server manual.

- Removes the following options for the ``Db.command()`` method:

  - ``willRetryWrite``
  - ``omitReadPreference``
  - ``writeConcern``
  - ``explain``
  - ``readConcern``
  - ``collation``
  - ``maxTimeMS``
  - ``comment``
  - ``retryWrites``
  - ``dbName``
  - ``authdb``
  - ``noResponse``

  Although you cannot pass these options to the
  ``Db.command()`` method, you can still set them in the command
  document. To learn more, see the :ref:`Command Options
  <node-command-options>` section of the Run a Command guide.

To learn more about this release, see the
`v6.0.0 Release Highlights <https://github.com/mongodb/node-mongodb-native/releases/tag/v6.0.0>`__.